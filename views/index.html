<html>
    <head>
        <link rel="stylesheet" href="/assets/bootstrap-5.2.3-dist/bootstrap-5.2.3-dist/css/bootstrap.min.css">
        <script src="/assets/bootstrap-5.2.3-dist/bootstrap-5.2.3-dist/js/bootstrap.min.js"></script>
        <script src="/assets/jquery/jquery-3.7.1.min.js"></script>
        <style>
          .feeding-time-div {
            display: flex;
            align-items: center;
          }
        </style>
        <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>



    </head>
    <body class="bg-light">

<div class="container py-5">

  <h1 class="mb-4 text-center">IoT Based Room Temperature Monitoring System with Automated Fan Opening and Smart Food Dispensing for Pets and SMS Notification.</h1>

  <div class="row g-4">

    <!-- Temperature Card -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0">Input Temperature to open the fan</h5>
        </div>
        <div class="card-body">
          <form id="tempForm">
            <div class="mb-3">
              <label class="form-label">Temperature (Â°C)</label>
              <input type="number" class="form-control" name="temperature" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Save Temperature</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Pet Feeding Time Card -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">Pet Feeding Times</h5>
        </div>
        <div class="card-body">
          <form id="feedingForm">
            <div id="feedingTimes">
              <div class="feeding-time-div">
                <div class="mb-3 feeding-item">
                  <label class="form-label">Feeding Time</label>
                  <input type="time" class="form-control" name="feeding_time[]" required>
                </div>
                <div class="ms-2">
                  <button type="button" class="btn btn-sm btn-outline-danger">Remove</button>
                </div>
              </div>
            </div>

            <button type="button" class="btn btn-outline-success w-100 mb-2" id="addFeedingTime">
              + Add Another Time
            </button>

            <button type="submit" class="btn btn-success w-100">Save Feeding Times</button>
          </form>
        </div>
      </div>
    </div>

    <!-- Mobile Numbers Card -->
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-header bg-warning">
          <h5 class="mb-0">Mobile Numbers for SMS Notification</h5>
        </div>
        <div class="card-body">
          <form id="mobileForm">
            <div id="mobileNumbers">
              <div class="mb-3 mobile-item">
                <label class="form-label">Mobile Number</label>
                <input type="text" class="form-control mobile-number-input" name="mobile_number[]" placeholder="+639XXXXXXXXX" required>
              </div>
            </div>

            <button type="button" class="btn btn-outline-warning w-100 mb-2" id="addMobileNumber">
              + Add Another Number
            </button>

            <button type="submit" class="btn btn-warning w-100">Save Numbers</button>
          </form>
        </div>
      </div>
    </div>

  </div>
</div>
<script>
  const socket = io();

  socket.emit('message', 'Hello server');

  socket.on('reply', msg => {
    console.log(msg);
  });


</script>
<script>
    // Add feeding time input
    $('#addFeedingTime').on('click', function () {
        $('#feedingTimes').append(`
          <div class="feeding-time-div">
            <div class="mb-3 feeding-item">
              <label class="form-label">Feeding Time</label>
              <input type="time" class="form-control" name="feeding_time[]" required>
            </div>
            <div class="ms-2">
              <button type="button" class="btn btn-sm btn-outline-danger">Remove</button>
            </div>
          </div>
        `);
    });

    // Add mobile number input
    $('#addMobileNumber').on('click', function () {
        $('#mobileNumbers').append(`
          <div class="feeding-time-div">
            <div class="mb-3 mobile-item">
              <label class="form-label">Mobile Number</label>
              <input type="text" class="form-control mobile-number-input" name="mobile_number[]" placeholder="+639XXXXXXXXX" required>
            </div>
            <div class="ms-2">
                <button type="button" class="btn btn-sm btn-outline-danger">Remove</button>
            </div>
          </div>
        `);
    });
    $(document.body).on('keyup', '.mobile-number-input',function () {
      const value = $(this).val();

      if (/^(09|\+639|639)\d{9}$/.test(value)) {
        $(this).addClass('is-valid').removeClass('is-invalid');
      } else {
        $(this).addClass('is-invalid').removeClass('is-valid');
      }
    });


    // Form submit handlers (optional)
    $('#tempForm').on('submit', function (e) {
        e.preventDefault();
        let temp_value = $("#tempForm input[name='temperature']").val();

      $.ajax({
          url: "/api/save_temperature_settings",
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          data: JSON.stringify({
            "tempValue": temp_value
          }),
      }).done(function (data) {
        alert(data.description)
      });

    });

    $('#feedingForm').on('submit', function (e) {
        e.preventDefault();
        const feedingTimes = [];
        $('#feedingForm [name="feeding_time[]"]').each(function () {
            feedingTimes.push($(this).val());
        });
        console.log("feedingTimes>>>>", feedingTimes);

        $.ajax({
          url: "/api/save_feeding_time",
          method: "POST",
          timeout: 0,
          headers: {
            "Content-Type": "application/json"
          },
          data: JSON.stringify({
            feeding_times: JSON.stringify(feedingTimes)
          }),
        }).done(function (data) {
          alert(data.description)
          getFeedingTime();
        });
    });

    $('#mobileForm').on('submit', function (e) {
        e.preventDefault();
        const mobileNumbers = [];
        $('#mobileForm input[name="mobile_number[]"].is-valid').each(function () {
            mobileNumbers.push($(this).val());
        });
        console.log("Mobile numbers", mobileNumbers); 

        $.ajax({
          url: "/api/save_mobile_number",
          method: "POST",
          timeout: 0,
          headers: {
            "Content-Type": "application/json"
          },
          data: JSON.stringify({
            "mobile_numbers": JSON.stringify(mobileNumbers)
          }),
        }).done(function (data) {
          alert(data.description)
          getMobileNumberList();
        });

    });
    $(document.body).on("click", ".remove-feeding-time", function() {
      let feeding_id = $(this).data("feeding_time_id");
      // 
      $.ajax( {
        url: "/api/remove_feeding_time",
        method: "POST",
        timeout: 0,
        headers: {
          "Content-Type": "application/json"
        },
        data: JSON.stringify({
          feeding_time_id: feeding_id
        }),
      }).done(function (data) {
        alert(data.description)
        getFeedingTime();
      });
    })
    $(document.body).on("click", ".remove-mobile-number", function() {
      let mobile_number_id = $(this).data("mobile_number_id");
      // 
      $.ajax( {
        url: "/api/remove_mobile_number",
        method: "POST",
        timeout: 0,
        headers: {
          "Content-Type": "application/json"
        },
        data: JSON.stringify({
          mobile_number_id: mobile_number_id
        }),
      }).done(function (data) {
        alert(data.description)
        getMobileNumberList();
      });
    })
    const getTemperature = () => {
      $.ajax({
        "url": "/api/get_temperature_config",
        "method": "GET",
        "timeout": 0,
      }).done(function (data) {
        if (!data) {
          return; 
        }

        if (data.length) {
          $("#tempForm input[name='temperature']").val(data[0].temperature);
        }
      });
    }
    const getFeedingTime = () => {
      $.ajax({
        "url": "/api/get_feeding_time",
        "method": "GET",
        "timeout": 0,
      }).done(function (data) {
        console.log(data);
        if (data.length) {
          $('#feedingTimes').empty();
          data.map(x=>{
            $('#feedingTimes').append(
              $("<div>").addClass("feeding-time-div").append(
                $("<div>").addClass("mb-3 feeding-item").append(
                  $("<label>").addClass("form-label").text("Feeding Time"),
                  $("<input>").attr({
                    type: 'time',
                    class: 'form-control',
                    name: 'feeding_time[]',
                    required: true,
                    value: x.time
                  }),
                ),
                $("<div>").addClass("ms-2").append(
                  $("<button>").attr({
                    type: "button",
                    class: "btn btn-sm btn-outline-danger remove-feeding-time"
                  }).data({
                    feeding_time_id: x.id
                  }).text("Remove")
                ),
              )
            );
          })          
        }
      });
    }

    const getMobileNumberList = () => {
      $.ajax({
        "url": "/api/get_mobile_number",
        "method": "GET",
        "timeout": 0,
      }).done(function (data) {
        console.log(data);
        if (data.length) {
          $('#mobileNumbers').empty();
          data.map(x=>{
            $('#mobileNumbers').append(
              $("<div>").addClass("feeding-time-div").append(
                $("<div>").addClass("mb-3 feeding-item").append(
                  $("<label>").addClass("form-label").text("Mobile Number"),
                  $("<input>").attr({
                    type: 'text',
                    class: 'form-control mobile-number-input is-valid',
                    name: 'mobile_number[]',
                    required: true,
                    value: x.mobile_number
                  }),
                ),
                $("<div>").addClass("ms-2").append(
                  $("<button>").attr({
                    type: "button",
                    class: "btn btn-sm btn-outline-danger remove-mobile-number"
                  }).data({
                    mobile_number_id: x.id
                  }).text("Remove")
                ),
              )
            );
          })          
        }
      });
    }
    const checkIfValidMobileNumber = num => {
      return /^(09|\+639|639)\d{9}$/.test(num);
    }

    getTemperature();
    getFeedingTime();
    getMobileNumberList();
</script>

</body>
</html>